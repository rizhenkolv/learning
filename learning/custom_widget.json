
      {
        "alias": "gauge_card2",
        "name": "Gauge Card",
        "descriptor": {
          "type": "timeseries",
          "sizeX": 4,
          "sizeY": 5,
          "resources": [],
          "templateHtml": "",
          "templateCss": "#container {\n    overflow: auto;\n}\n\n.tbDatasource-container {\n    margin: 1px;\n    padding: 0px;\n    \n    width: 100%;\n    height:  1px;\n    \n    position: relative;\n}\n\n.tbDatasource-table {\n    width: 50%;\n    height:  1px;\n    box-shadow: 0 0 1px #ccc;\n    border-collapse: collapse;\n    margin:auto;\n    position: relative;\n    white-space: nowrap;\n}\n\n.tbDatasource-table td {\n    position: relative;\n    border-top: 1px solid rgba(0, 0, 0, .12);\n    padding: 0px 0px;\n    box-sizing: border-box;\n    \n    text-align: center;\n}\n",
          "controllerScript": "\nvar timoutValue=60000;\nlet first = 0;\nself.detectLastDate = function(tbDatasource, baseInd){\n    var lastDate=0;\n    var dtklen = tbDatasource.dataKeys.length;\n    for (var a = 0; a < dtklen; a++) \n    {\n        var cellData = self.ctx.data[dtklen*baseInd+a];\n        if (cellData && cellData.data && cellData.data.length > 0) \n        {\n            var tvPair = cellData.data[cellData.data.length - 1];\n            var value = tvPair[1];\n            var ts = tvPair[0];\n            if(ts>lastDate)lastDate = ts;\n        }\n    }\n    \n    return lastDate; \n}\n\nself.sensSize = function(tbDatasource, baseInd){\n    var lineSize=1;\n    var dtklen = tbDatasource.dataKeys.length;\n    \n    for (var a = 0; a < dtklen; a++) \n    {\n        var cellData = self.ctx.data[dtklen*baseInd+a];\n        if (cellData && cellData.data && cellData.data.length > 0) \n        {\n            var tvPair = cellData.data[cellData.data.length - 1];\n            var value = tvPair[1];\n            var ts = tvPair[0];\n            var tsnow = Date.now();\n            var diff = tsnow - ts ;\n            \n            if (ts == tbDatasource.lastDate && diff<timoutValue){ \n               lineSize*=(a+1);\n            } \n        }\n        \n    }\n    return lineSize;\n    \n}\nfunction sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nself.onInit = function() \n{\n    first = 0;\n}\n\n async function init() \n{\n    for (var i = 0; i < self.ctx.datasources.length; i++) {\n     \n        var tbDatasource = self.ctx.datasources[i];\n        tbDatasource.lastDate = self.detectLastDate(tbDatasource,i);\n        tbDatasource.multiLine=self.sensSize(tbDatasource,i);\n        \n        tbDatasource.gauges = [];\n        //tbDatasource.dataIndex = [];\n        \n        var datasourceId = 'tbDatasource' + i;\n        self.ctx.$container.append(\n            \"<span id='\" + datasourceId +\n            \"' class='tbDatasource-container'></span>\"\n        );\n        var datasourceContainer = $('#' +datasourceId,self.ctx.$container);\n       //datasourceContainer.append(\n       //    \"<div class='tbDatasource-title'>\" +tbDatasource.name +  \"</div>\"\n       //);\n       var datasourceTitleCell = $('.tbDatasource-title',datasourceContainer);\n       tbDatasource.datasourceTitleCell= datasourceTitleCell;\n        var tableId = 'table' + i;\n        datasourceContainer.append(\n            \"<table id='\" + tableId + \"' class='tbDatasource-table'>  </table>\" );\n        var table = $('#' + tableId, self.ctx.$container);\n        \n        \n        var dtklen = tbDatasource.dataKeys.length;\n        \n        for (var a = 0; a < dtklen; a++) \n        {\n            var cellData = self.ctx.data[i*dtklen+a];\n              \n            if (cellData && cellData.data && cellData.data.length > 0) \n            {\n               \n                var tvPair = cellData.data[cellData.data.length - 1];\n                var value = tvPair[1];\n                var ts = tvPair[0];\n                var tsnow = Date.now();\n               var diff = tsnow - ts ;\n               \n                if (ts != tbDatasource.lastDate || diff>=timoutValue){ \n                    tbDatasource.gauges.push(0);\n                    continue;\n                } \n            }else{\n                tbDatasource.gauges.push(0);\n                continue;\n            }\n            \n           \n             var dataKey = self.ctx.datasources[0].dataKeys[a];\n            \n            var gaugeId = 'gauge' + i*dtklen+a;\n            \n            var line = \"<tr ><td> <canvas height='20' id='\"+ gaugeId+\"'></canvas> </td> </tr>\";\n          \n           \n            table.append(line);\n            //tbDatasource.dataIndex.push(a);\n            \n            var gauge = new TbCanvasDigitalGauge(self.ctx,gaugeId); \n            tbDatasource.gauges.push(gauge);\n           \n            var opt = gauge.gauge.options;\n            opt.minValue = dataKey.settings.axisMin; \n            opt.maxValue = dataKey.settings.axisMax; \n            opt.animation=false;\n            opt.units=true;\n            opt.symbol=\" \"+dataKey.units;\n           \n            opt.hideMinMax = false;\n            opt.hideValue = false;\n            opt.title = dataKey.label;\n            opt.valueDec=dataKey.decimals;\n            opt.gaugeColor = \"#ddd\";\n            opt.colorMinMax = \"#666\";\n            opt.colorTitle = dataKey.color;\n            opt.colorValue = dataKey.color;\n            opt.colorLabel = dataKey.color;\n            opt.levelColors[0] = dataKey.color;\n            opt.colorsRange[0].rgbString= dataKey.color;\n            \n            \n        }\n    }\n}\n\nself.onDataUpdated = function() \n{\n    first++;\n    if(first<2 ){ return;}\n        \n    if(first==2 )\n    { \n        init(); \n        self.onResize();\n        self.ctx.detectChanges(true);\n    }\n\n    for (var i = 0; i < self.ctx.datasources.length; i++) {\n        \n        var tbDatasource = self.ctx.datasources[i];\n        tbDatasource.lastDate = self.detectLastDate(tbDatasource,i);\n        var calcMultiLine = self.sensSize(tbDatasource,i);\n\n            if(tbDatasource.multiLine!=calcMultiLine){\n                \n                self.ctx.$container.empty();\n                first=1;\n                break;\n            }\n        for (var a = 0; a < tbDatasource.gauges.length; a++) {\n            if(tbDatasource.gauges[a]==0){\n                continue;\n            }\n            \n            var dtklen = tbDatasource.dataKeys.length;\n            var cellData = self.ctx.data[i*dtklen+ a];\n            \n            if (cellData && cellData.data && cellData.data.length > 0) {\n                var tvPair = cellData.data[cellData.data.length - 1];\n                var value = tvPair[1];\n                \n                tbDatasource.gauges[a].gauge.value = (value);\n                tbDatasource.gauges[a].gauge.update();\n               \n            }\n        }\n    }\n\n    function isNumber(n) {\n        return !isNaN(parseFloat(n)) && isFinite(n);\n    }\n}\n\nself.onResize = function() {\n    for (var i = 0; i < self.ctx.datasources.length; i++) {\n        var tbDatasource = self.ctx.datasources[i];\n        for (var a = 0; a < tbDatasource.gauges.length; a++) {\n            if(tbDatasource.gauges[a]==0){\n                continue;\n            }\n            var opt = tbDatasource.gauges[a].gauge.options;\n            opt.width=Math.min( self.ctx.height, self.ctx.width)*90/100;\n            opt.height = opt.width*50/100;\n        }\n        var datasourceTitleFontSize = self.ctx.height / 8;\n        if (self.ctx.width / self.ctx.height <= 1.5) {\n            datasourceTitleFontSize = self.ctx.width / 12;\n        }\n        datasourceTitleFontSize = Math.min( datasourceTitleFontSize, 20);\n        \n        tbDatasource.datasourceTitleCell.css('font-size', datasourceTitleFontSize +'px');\n    }\n}\nself.getSettingsSchema = function() {\n    return TbCanvasDigitalGauge.settingsSchema;\n}\nself.getDataKeySettingsSchema = function() {\n    return TbFlot.datakeySettingsSchema(true, 'graph');\n}\nself.onDestroy = function() {}",
          "settingsSchema": "{}",
          "dataKeySettingsSchema": "{}\n",
          "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{\"showLines\":true,\"fillLines\":false,\"showPoints\":false,\"showPointShape\":\"circle\",\"pointShapeFormatter\":\"var size = radius * Math.sqrt(Math.PI) / 2;\\nctx.moveTo(x - size, y - size);\\nctx.lineTo(x + size, y + size);\\nctx.moveTo(x - size, y + size);\\nctx.lineTo(x + size, y - size);\",\"showPointsLineWidth\":5,\"showPointsRadius\":3,\"axisPosition\":\"left\",\"axisMax\":1000,\"axisMin\":-1000},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\",\"units\":\"r1\",\"decimals\":2,\"usePostProcessing\":null,\"postFuncBody\":null},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{\"excludeFromStacking\":false,\"hideDataByDefault\":false,\"disableDataHiding\":false,\"removeFromLegend\":false,\"showLines\":true,\"fillLines\":false,\"showPoints\":false,\"showPointShape\":\"circle\",\"pointShapeFormatter\":\"var size = radius * Math.sqrt(Math.PI) / 2;\\nctx.moveTo(x - size, y - size);\\nctx.lineTo(x + size, y + size);\\nctx.moveTo(x - size, y + size);\\nctx.lineTo(x + size, y - size);\",\"showPointsLineWidth\":5,\"showPointsRadius\":3,\"showSeparateAxis\":false,\"axisPosition\":\"left\",\"thresholds\":[{\"thresholdValueSource\":\"predefinedValue\"}],\"comparisonSettings\":{\"showValuesForComparison\":true},\"axisMin\":-1000,\"axisMax\":1000},\"_hash\":0.299669924944151,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\",\"units\":\"r2\",\"decimals\":null,\"usePostProcessing\":null,\"postFuncBody\":null}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"maxValue\":100,\"gaugeType\":\"horizontalBar\",\"donutStartAngle\":90,\"timestampFormat\":\"yyyy-MM-dd HH:mm:ss\",\"showValue\":true,\"showMinMax\":true,\"gaugeWidthScale\":0.75,\"animation\":true,\"animationDuration\":500,\"animationRule\":\"linear\",\"titleFont\":{\"family\":\"Roboto\",\"size\":12,\"style\":\"normal\",\"weight\":\"500\"},\"labelFont\":{\"family\":\"Roboto\",\"size\":8,\"style\":\"normal\",\"weight\":\"500\"},\"valueFont\":{\"family\":\"Roboto\",\"size\":18,\"style\":\"normal\",\"weight\":\"500\"},\"minMaxFont\":{\"family\":\"Roboto\",\"size\":10,\"style\":\"normal\",\"weight\":\"500\"},\"minValue\":2000},\"title\":\"Gauge Card\",\"showTitleIcon\":false,\"iconColor\":\"rgba(0, 0, 0, 0.87)\",\"iconSize\":\"24px\",\"titleTooltip\":\"\",\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{},\"titleStyle\":{\"fontSize\":\"16px\",\"fontWeight\":400},\"showLegend\":false,\"useDashboardTimewindow\":false,\"displayTimewindow\":false}"
        },
        "image": "data:image/png;base64,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",
        "description": "Displays one or more latest values of the entity. Supports multiple entities."
      }